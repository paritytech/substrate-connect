name: chain-specs-periodic-update

on:
  push:
    branches: [ tka-update-chain-specs-ci ]   #Â TODO: remove before merging, I'm just testing
  schedule:
    - cron: '0 8 * * *'  # every day at 8am


jobs:
  download-spec:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        rpc-node-address: [
          "wss://rpc.polkadot.io",
          "wss://kusama-rpc.polkadot.io",
          "wss://westend-rpc.polkadot.io",
          "wss://rococo-rpc.polkadot.io"
        ]
      fail-fast: false   # Don't automatically cancel the jobs of the other RPC nodes if one fails

    steps:
    - uses: actions/checkout@v3
    - run: |
        curl -L -O https://github.com/vi/websocat/releases/download/v1.9.0/websocat_linux64
        chmod +x websocat_linux64
    - run: |
        echo '{"id":1,"jsonrpc":"2.0","method":"sync_state_genSyncSpec","params":[true]}' |
          ./websocat_linux64 -n1 -B 99999999 ${{ matrix.rpc-node-address }} |
          jq .result > chain_spec.json
    - id: get-chain-id  # Reads the `id` field in the newly-downloaded chain spec
      run: echo "::set-output name=id::`jq -r .id ./chain_spec.json`"
    - run: |  # Overwrite the `lightSyncState` field of the existing chain spec with the value of spec that's been downloaded.
        tmp=$(mktemp)
        output=./packages/connect/src/connector/specs/${{ steps.get-chain-id.outputs.id }}.json
        jq --slurpfile downloaded ./chain_spec.json '.lightSyncState = $downloaded[0].lightSyncState' "$output" > "$tmp"
        mv "$tmp" "$output"
    - run: |
        cp ./packages/connect/src/connector/specs/${{ steps.get-chain-id.outputs.id }}.json ./projects/extension/public/assets/${{ steps.get-chain-id.outputs.id }}.json
    - uses: actions/upload-artifact@v3
      with:
        name: chain-spec-${{ steps.get-chain-id.outputs.id }}
        path: |
          packages/**/*.json
          projects/**/*.json

  create-pr:
    runs-on: ubuntu-latest
    if: ${{ always() }}   # Run this job even if one of the steps of download-spec has failed
    needs: download-spec

    steps:
    - uses: actions/checkout@v3
    - uses: actions/download-artifact@v3
      with:
        # Since we're not passing a name, this automatically downloads *all* artifacts
        path: .
    - uses: peter-evans/create-pull-request@v4
      with:
        branch: update-checkpoints
        title: Update checkpoints in chain specifications
        body: |
          This pull request has been automatically generated by downloading chain
          specifications from various JSON-RPC nodes and extracting its checkpoint.
        commit-message: Update checkpoints in chain specifications
        delete-branch: true
