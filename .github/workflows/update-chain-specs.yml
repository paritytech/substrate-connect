name: chain-specs-periodic-update

on:
  push:
    branches: [ tka-update-chain-specs-ci ]   #Â TODO: remove before merging, I'm just testing
  schedule:
    - cron: '0 8 * * *'  # every day at 8am


jobs:
  download-spec:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        rpc-node-address: [
          "wss://rpc.polkadot.io",
          "wss://kusama-rpc.polkadot.io",
          "wss://westend-rpc.polkadot.io",
          "wss://rococo-rpc.polkadot.io"
        ]
      fail-fast: false   # Don't automatically cancel the jobs of the other RPC nodes if one fails

    steps:
    - uses: actions/checkout@v3
    - run: |
        curl -L -O https://github.com/vi/websocat/releases/download/v1.9.0/websocat_linux64
        chmod +x websocat_linux64
    - run: |
        echo '{"id":1,"jsonrpc":"2.0","method":"sync_state_genSyncSpec","params":[true]}' |
        ./websocat_linux64 -n1 -B 99999999 ${{ matrix.rpc-node-address }} |
        jq .result > chain_spec.json
    - id: get-chain-id  # Reads the `id` field in the newly-downloaded chain spec
      run: echo "::set-output name=id::`jq -r .id ./chain_spec.json`"
    - uses: actions/upload-artifact@v3
      with:
        name: chain-spec-${{ steps.get-chain-id.outputs.id }}
        path: ./chain_spec.json
    - run: |  # Overwrite the `lightSyncState` field of the existing chain spec with the value of spec that's been downloaded.
        tmp=$(mktemp)
        output=./packages/connect/src/connector/specs/${{ steps.get-chain-id.outputs.id }}.json
        jq --slurpfile downloaded ./chain_spec.json '.lightSyncState = $downloaded[0].lightSyncState' "$output" > "$tmp"
        mv "$tmp" "$output"
    - run: |
        cp ./packages/connect/src/connector/specs/${{ steps.get-chain-id.outputs.id }}.json ./projects/extension/public/assets/${{ steps.get-chain-id.outputs.id }}.json
    - uses: peter-evans/create-pull-request@v4
      with:
        branch: update-checkpoint-${{ steps.get-chain-id.outputs.id }}
        title: Update checkpoint of chain ${{ steps.get-chain-id.outputs.id }}
        body: |
          This pull request has been automatically generated by downloading the chain
          specification from ${{ matrix.rpc-node-address }} and extracting its checkpoint.
        commit-message: Update checkpoint of chain ${{ steps.get-chain-id.outputs.id }}
        add-paths: |   # Don't include iin the PR the garbage we put at the root
          packages/**/*.json
          projects/**/*.json
        delete-branch: true
